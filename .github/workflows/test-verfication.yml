name: Production Gatekeeper

concurrency:
  group: verification-${{ github.sha }}
  cancel-in-progress: false

on:
  push:
    branches:
      - Test

jobs:
  verify-success-file:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: Test
          fetch-depth: 0

      - name: Validate Success File
        run: |
          if ! git show HEAD:Test-success.flag; then
            echo "::error::Test success file not found in latest commit!"
            exit 1
          fi

  promote-to-Deployment:
    needs: verify-success-file
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: Deployment

      - name: Merge Test to Deployment
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git pull origin Deployment
          git merge Test --no-ff -m "Production Release: Verified by $(git log -1 --pretty=format:'%ae' Test)"
          git push origin Deployment

      - name: Cleanup Test Branch
        run: |
          git push origin --delete Test || echo "Test branch already deleted"

  trigger-Deployment:
    needs: promote-to-Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Deployment Workflow
        uses: actions/github-script@v6
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        with:
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy.yml',
              ref: 'Deployment'
            })
